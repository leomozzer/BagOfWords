parameters:
  - name: awsSecret
  - name: awsKey
  - name: appName
  - name: appLocation
  - name: cloudService
  - name: serviceConnectionName
  - name: stageDeployment
  - name: storageName

steps:
  - task: S3Download@1
    inputs:
      awsCredentials: 'AWS-Connection'
      regionName: 'us-east-1'
      bucketName: '${{ parameters.storageName }}'
      sourceFolder: 'plan'
      globExpressions: 'terraform-main-${{ parameters.stageDeployment }}.tar'
      targetFolder: '$(System.DefaultWorkingDirectory)'

  - task: CmdLine@2 
    inputs:
      script: 'tar -xvf terraform-main-${{ parameters.stageDeployment }}.tar'
      workingDirectory: '$(System.DefaultWorkingDirectory)/plan'
    displayName: 'Extract files'

  - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
    inputs:
      terraformVersion: 0.14.7
    displayName: 'Install Terraform'
  
  - task: TerraformCLI@0
    inputs:
      command: 'apply'
      allowTelemetryCollection: true
      workingDirectory: '$(System.DefaultWorkingDirectory)/plan'
      commandOptions: -auto-approve -lock-timeout=10m ${{ parameters.stageDeployment }}.plan"
      environmentServiceName: 'AzureDevOps'
    displayName: 'Terraform Apply'